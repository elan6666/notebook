---
title: "Scouter 方法笔记（重点：Methods）"
tags: [perturbation, scRNA, perturb-seq, Scouter, GenePT, embedding, MLP]
aliases: ["Scouter method", "compressor-generator", "autofocus direction-aware loss"]
---
---


## 1. 方法一句话
Scouter 用 **LLM/GenePT 的基因文本 embedding** 表达“扰动基因语义”，再用一个 **轻量的 Compressor–Generator MLP**：把 control 细胞状态压缩成低维向量，与扰动 embedding 拼接后生成扰动后的全基因表达。

---

## 2. 任务与数据组织（Triplets）
### 2.1 输入/输出定义
- 输入（训练时）：
  - `c_i`：随机抽取的一个 **control cell** 的表达向量（高维、稀疏）
  - `E(p_i)`：扰动基因 `p_i` 的 gene embedding（固定维度向量）
- 输出（监督目标）：
  - `x_i`：对应扰动细胞 `i` 的真实表达向量
- 模型预测：
  - `x̂_i`：模型输出的预测表达向量

### 2.2 为什么要“随机 control 配对”
同一个扰动在不同细胞背景下表现会不同；随机抽 control 让模型学习到“背景状态分布”并减少对某个特定 control 的依赖。

---

## 3. GenePT / LLM 基因 embedding（Scouter 的关键先验）
### 3.1 embedding 是什么
- 每个基因 `g` 对应一个固定向量 `E(g)`（维度在论文中固定为 1536）。
- 这些向量来自基因的文本描述（例如基因功能摘要等）经 LLM embedding 得到。

### 3.2 训练中怎么用
- embedding **冻结（non-trainable）**：训练只更新 Scouter 的 MLP 参数，不更新 `E(g)`。
- embedding 在所有扰动条件中共享：同一个基因无论出现在什么数据集/扰动组合，映射到同一个向量空间。

---

## 4. 网络结构（Compressor–Generator）
Scouter 有两部分：

### 4.1 Compressor：把 control 表达压成 cell-state
- 作用：将高维稀疏 `c_i` 压缩为紧凑的 cell-state `S_i`
- 形式：
  - `S_i = C(c_i)`
- 结构（论文固定配置）：
  - MLP hidden: 2048 → 512
  - bottleneck: 64（非常关键：强约束信息容量）

### 4.2 Generator：条件生成扰动后表达
- 输入：`S_i` 与 `E(p_i)` 的拼接
- 输出：预测表达 `x̂_i`（维度 = 基因数）
- 形式：
  - `x̂_i = D( concat(S_i, E(p_i)) )`
- 结构（论文固定配置）：
  - 1 个 hidden layer: 2048
  - output layer: 维度匹配基因表达维度

### 4.3 激活、正则、归一化（论文配置要点）
- 激活：SELU
- Dropout：默认关闭（dropout rate=0），但结构支持 AlphaDropout
- BatchNorm：每个 hidden layer 后启用
- LayerNorm：关闭

> 实现上你可以记成：  
> `Linear → SELU → BatchNorm`（默认不加 Dropout）  
> Compressor 最后输出 64 维 cell-state；Generator 输出 |G| 维表达。

---

## 5. 推理策略（K 个 control 采样 + 平均）
预测某个扰动基因 `g` 时：
1. 固定扰动 embedding：`E(g)`
2. 从 control 集合随机采样 `K` 个 `c_1..c_K`（论文默认 K=300）
3. 得到 `K` 个预测 `x̂_1..x̂_K`
4. 需要单点预测时取均值：`x̂_mean = (1/K) Σ x̂_k`

直觉：这是对“背景细胞状态分布”的 Monte Carlo 平均，能明显降低输出方差、使预测更稳。

---

## 6. 双基因扰动（two-gene，Norman 等）
Scouter 对双扰动的做法非常简单：
- 先把两个基因的 embedding **相加**：`E(g1,g2) = E(g1) + E(g2)`
- 然后按单基因流程：`x̂ = D( concat(S, E(g1,g2)) )`

> 结论：  
> - 单基因：embedding 与 cell-state **concat**  
> - 双基因：embedding **先 sum 再 concat**

---

## 7. 损失函数（autofocus + direction-aware）
Scouter 的训练损失来自两部分：

### 7.1 Autofocus loss（幂次 MSE，强调大误差/大变化基因）
- 形式上是将误差从平方提升为 `2 + γ` 次幂
- 直觉：误差越大惩罚增长越快 → 训练更“盯住”大变化的基因（常与 DEGs 更相关）

### 7.2 Direction-aware loss（方向一致性惩罚）
- 比较相对 control 的变化方向：
  - 真实方向：`sign(x_i - c_i)`
  - 预测方向：`sign(x̂_i - c_i)`
- 直觉：专门惩罚“上调预测成下调”或反过来的错误（方向错往往比幅度小偏差更致命）

### 7.3 总损失
- `L = L_autofocus + λ * L_direction`
- `λ` 控制方向项的重要性；`γ` 控制 autofocus 的聚焦程度

---

## 8. 训练配置（Training configuration）
### 8.1 优化与学习率策略
- Optimizer：Adam
- 初始学习率：从 {0.001, 0.005, 0.01} 中网格搜索选择
- 每个 epoch 学习率指数衰减：decay factor = 0.9

### 8.2 训练过程控制
- batch size：256
- max epochs：40
- early stopping：基于验证集 loss
  - patience = 5
  - min improvement threshold = 0.001
- gradient clipping：max-norm = 1.0
- checkpoint：训练中保留验证集 loss 最低的模型，结束时恢复该权重

---

## 9. 超参选择（Selection of hyperparameters）
作者固定了大部分结构/训练设置，只对少数关键项做网格搜索：
- loss 的 `γ`
- loss 的 `λ`
- 初始学习率

并给出了每个数据集最终选择的 `(λ, lr)` 组合（`γ` 最终统一取 0）。

---

## 10. 数据划分（Data splits：避免泄漏的关键）
核心原则：**按 perturbation（扰动类别）做 hold-out**，保证 train/val 中不出现 test 扰动。

常见设置：
- Adamson / Norman / Replogle：重复 5 个不同 splits
  - 20% perturbations 做 test
  - 剩余 80% perturbations 再分 train/val（90%/10%）
- Dixit：由于扰动类别更少，重复 10 个 splits，比例 80/10/10

最终报告：对多个 splits 的 test 指标取平均。

---

## 11. 实现提示（你复现时最容易踩坑的点）
1. **别把 split 做成“随机按细胞划分”**：必须按扰动类别 hold-out，否则会数据泄漏、指标虚高。  
2. **两个 γ 容易混**：一个是学习率衰减因子（0.9），另一个是 autofocus loss 的幂指数（γ）。建议在代码里重命名。  
3. **embedding 冻结**：不要把 GenePT embedding 当作可训练层去更新。  
4. **推理要做 K-sampling**：只用一个 control 细胞会让输出抖动明显；K=300 是论文默认的稳定做法。  
5. **双基因是先 sum embedding**：不要把两个 embedding 直接 concat（论文不是这么做的）。

---

## 12. 方法的“最小复现”流程（Checklist）
- [ ] 准备表达矩阵与 control/perturb 标注
- [ ] 准备基因 → embedding（1536 维）映射表，并冻结
- [ ] 构造 triplets：每个 perturbed cell 随机配一个 control cell
- [ ] 搭建网络：
  - Compressor: 2048 → 512 → 64
  - Generator: (64 + 1536) → 2048 → |G|
- [ ] 损失：autofocus + λ * direction-aware
- [ ] 训练：Adam + LR decay + early stopping + grad clip
- [ ] 推理：对 K 个 control 采样并平均；双基因 embedding 先相加再推理
